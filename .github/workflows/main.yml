name: Ultimate Security Environment (Hashcat + John)
run-name: üíÄ Deploying Security Lab by ${{ github.actor }}

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  super-hacker-job:
    name: ‚ö° Power Security Runner
    runs-on: ubuntu-latest
    
    env:
      DEBIAN_FRONTEND: noninteractive
      # T·ªëi ∆∞u cho Hashcat ch·∫°y tr√™n CPU (V√¨ GitHub Runner kh√¥ng c√≥ GPU r·ªùi)
      OpenCL_VENDOR_PATH: /etc/OpenCL/vendors

    steps:
      # 1. L·∫•y code v·ªÅ
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      # 2. Kh·ªüi t·∫°o & T·ªëi ∆∞u Kernel (Mode "C·ª±c M·∫°nh")
      - name: üõ†Ô∏è System Tuning & Optimization
        run: |
          echo ">>> [INIT] N√¢ng c·∫•p h·ªá th·ªëng..."
          sudo apt-get update -qq
          
          # C√†i c√°c g√≥i c∆° b·∫£n + th∆∞ vi·ªán OpenCL cho Hashcat
          sudo apt-get install -y -qq build-essential curl wget git htop neofetch \
            software-properties-common ocl-icd-libopencl1 pocl-opencl-icd

          # T·ªëi ∆∞u m·∫°ng TCP BBR ƒë·ªÉ k·∫øt n·ªëi VPN m∆∞·ª£t nh·∫•t
          echo ">>> [TUNING] K√≠ch ho·∫°t TCP BBR..."
          sudo sysctl -w net.core.default_qdisc=fq || true
          sudo sysctl -w net.ipv4.tcp_congestion_control=bbr || true

      # 3. C√ÄI ƒê·∫∂T V≈® KH√ç B·∫¢O M·∫¨T (Hashcat, John, Hydra)
      - name: üíÄ Install Security Tools (Hashcat & John)
        run: |
          echo ">>> [INSTALL] ƒêang c√†i ƒë·∫∑t b·ªô c√¥ng c·ª•..."
          
          # C√†i Hashcat & Hydra
          sudo apt-get install -y hashcat hydra
          
          # C√†i John the Ripper (B·∫£n Snap th∆∞·ªùng m·ªõi h∆°n v√† ƒë·ªß t√≠nh nƒÉng h∆°n apt m·∫∑c ƒë·ªãnh)
          sudo snap install john-the-ripper

          # T·∫£i wordlist rockyou.txt (Huy·ªÅn tho·∫°i) v·ªÅ s·∫µn ƒë·ªÉ d√πng lu√¥n
          echo ">>> [DATA] ƒêang t·∫£i wordlist RockYou..."
          wget -q https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt
          
          # Show phi√™n b·∫£n ƒë·ªÉ ki·ªÉm tra ƒë·ªô uy t√≠n
          echo "------------------------------------------------"
          echo "Hashcat Version:"
          hashcat --version
          echo "John Version:"
          /snap/bin/john-the-ripper --version
          echo "------------------------------------------------"

      # 4. K·∫øt n·ªëi Tailscale (S·ª≠ d·ª•ng ƒë√∫ng Secret c·ªßa b·∫°n)
      - name: üåê Connect to Tailscale VPN
        uses: tailscale/github-action@v2
        with:
          # ƒê√ÇY L√Ä CH·ªñ QUAN TR·ªåNG: Kh·ªõp v·ªõi ·∫£nh b·∫°n g·ª≠i
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
          version: latest
          args: --accept-routes --hostname=github-security-lab

      # 5. Benchmark (Test s·ª©c m·∫°nh CPU khi ch·∫°y Hash)
      - name: üî• Hashrate Benchmark
        run: |
          echo ">>> [POWER] Ki·ªÉm tra t·ªëc ƒë·ªô x·ª≠ l√Ω Hash (Benchmark)..."
          
          # Test th·ª≠ t·ªëc ƒë·ªô Hashcat (MD5)
          # L∆∞u √Ω: Ch·∫°y tr√™n CPU n√™n s·∫Ω kh√¥ng nhanh b·∫±ng GPU r·ªùi, nh∆∞ng v·∫´n r·∫•t m·∫°nh
          timeout 30s hashcat -b -m 0 -D 1 || true
          
          # Test th·ª≠ John
          /snap/bin/john-the-ripper --test=0

      # 6. Treo m√°y (Keep Alive) ƒë·ªÉ b·∫°n SSH v√†o ngh·ªãch
      - name: üöÄ Lab Ready - Waiting for SSH
        run: |
          echo ">>> [INFO] IP Tailscale c·ªßa m√°y n√†y:"
          tailscale ip -4
          echo ">>> [READY] M√°y ƒë√£ s·∫µn s√†ng! B·∫°n c√≥ th·ªÉ SSH v√†o ngay b√¢y gi·ªù."
          
          # L·ªánh n√†y gi√∫p m√°y kh√¥ng b·ªã t·∫Øt ngay, ch·ªù b·∫°n v√†o ƒëi·ªÅu khi·ªÉn
          # (L∆∞u √Ω: GitHub gi·ªõi h·∫°n t·ªëi ƒëa 6 ti·∫øng m·ªói l·∫ßn ch·∫°y)
          sleep 6h
          
