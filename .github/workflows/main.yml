name: Ultimate Security Environment (No Snap Hang)
run-name: ðŸ’€ Deploying Security Lab (Fixed) by ${{ github.actor }}

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  super-hacker-job:
    name: âš¡ Stable Security Runner
    runs-on: ubuntu-latest
    
    env:
      DEBIAN_FRONTEND: noninteractive
      OpenCL_VENDOR_PATH: /etc/OpenCL/vendors

    steps:
      # 1. Láº¥y code vá»
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # 2. Khá»Ÿi táº¡o & Tá»‘i Æ°u Kernel
      - name: ðŸ› ï¸ System Tuning & Optimization
        run: |
          echo ">>> [INIT] NÃ¢ng cáº¥p há»‡ thá»‘ng..."
          # Loáº¡i bá» snapd khá»i quÃ¡ trÃ¬nh update Ä‘á»ƒ trÃ¡nh bá»‹ treo
          sudo apt-mark hold snapd
          sudo apt-get update -qq
          
          # CÃ i cÃ¡c gÃ³i cÆ¡ báº£n + thÆ° viá»‡n OpenCL
          sudo apt-get install -y -qq build-essential curl wget git htop neofetch \
            software-properties-common ocl-icd-libopencl1 pocl-opencl-icd

          # Tá»‘i Æ°u máº¡ng TCP BBR
          echo ">>> [TUNING] KÃ­ch hoáº¡t TCP BBR..."
          sudo sysctl -w net.core.default_qdisc=fq || true
          sudo sysctl -w net.ipv4.tcp_congestion_control=bbr || true

      # 3. CÃ€I Äáº¶T VÅ¨ KHÃ Báº¢O Máº¬T (ÄÃ£ thay Snap báº±ng APT Ä‘á»ƒ khÃ´ng bá»‹ lá»—i)
      - name: ðŸ’€ Install Security Tools
        run: |
          echo ">>> [INSTALL] Äang cÃ i Ä‘áº·t bá»™ cÃ´ng cá»¥ (APT Version)..."
          
          # CÃ i Hashcat, Hydra vÃ  John the Ripper báº±ng APT (Nhanh & á»”n Ä‘á»‹nh)
          sudo apt-get install -y hashcat hydra john
          
          # Táº£i wordlist RockYou vá» dÃ¹ng luÃ´n
          echo ">>> [DATA] Äang táº£i wordlist RockYou..."
          wget -q https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt
          
          # Kiá»ƒm tra phiÃªn báº£n
          echo "------------------------------------------------"
          echo "Hashcat Version:"
          hashcat --version
          echo "John Version:"
          john --version
          echo "------------------------------------------------"

      # 4. Káº¿t ná»‘i Tailscale (Giá»¯ nguyÃªn khÃ³a bÃ­ máº­t cá»§a báº¡n)
      - name: ðŸŒ Connect to Tailscale VPN
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
          version: latest
          args: --accept-routes --hostname=github-security-lab

      # 5. Benchmark (Test sá»©c máº¡nh)
      - name: ðŸ”¥ Hashrate Benchmark
        run: |
          echo ">>> [POWER] Kiá»ƒm tra tá»‘c Ä‘á»™ xá»­ lÃ½ Hash..."
          # Test tá»‘c Ä‘á»™ Hashcat (MD5)
          timeout 30s hashcat -b -m 0 -D 1 || true
          
          # Test tá»‘c Ä‘á»™ John
          john --test=0

      # 6. Treo mÃ¡y Ä‘á»ƒ SSH
      - name: ðŸš€ Lab Ready - Waiting for SSH
        run: |
          echo ">>> [INFO] IP Tailscale cá»§a mÃ¡y nÃ y:"
          tailscale ip -4
          echo ">>> [READY] MÃ¡y Ä‘Ã£ sáºµn sÃ ng! HÃ£y SSH vÃ o ngay."
          sleep 6h
          
